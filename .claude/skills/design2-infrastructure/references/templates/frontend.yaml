# Frontend — Pre-filled Stack Template
# Static site hosting with CDN and custom domain.
# Hosting: S3 | CDN: CloudFront | DNS: Route53 + ACM

version: "1.0"

stack:
  name: ""                    # e.g. "acme-portal"
  type: "frontend"
  system: ""
  ecosystem: ""

parameters:
  environment: "dev"
  region: "us-east-1"
  domain_name: ""             # e.g. "portal.acme.com" (optional)
  acm_certificate_arn: ""     # ACM cert ARN (required if domain_name set, must be us-east-1)

# Architecture:
#
#   Route53 (custom domain alias)
#       |
#   CloudFront (CDN, HTTPS, caching, SPA routing)
#       |
#   S3 (static site files, private — OAC access only)

aws_resources:
  - logical_name: FrontendBucket
    type: AWS::S3::Bucket
    purpose: Static site file storage (HTML, JS, CSS, assets)
    properties:
      block_public_access: true     # CloudFront OAC handles access
      encryption: AES256
      versioning: false
      lifecycle_rules:
        - expire_noncurrent: 30     # Clean old versions

  - logical_name: FrontendCDN
    type: AWS::CloudFront::Distribution
    purpose: CDN with HTTPS, SPA routing, caching
    properties:
      origins:
        - domain: "{FrontendBucket.RegionalDomainName}"
          access: OAC               # Origin Access Control
      default_cache_behavior:
        viewer_protocol_policy: redirect-to-https
        cache_policy: CachingOptimized
        compress: true
      custom_error_responses:
        - error_code: 403
          response_code: 200
          response_page: /index.html  # SPA fallback routing
        - error_code: 404
          response_code: 200
          response_page: /index.html
      aliases: ["{domain_name}"]     # Only if domain_name set
      certificate: "{acm_certificate_arn}"  # Only if domain_name set
      default_root_object: index.html

  - logical_name: FrontendOAC
    type: AWS::CloudFront::OriginAccessControl
    purpose: Secure S3 access from CloudFront only
    properties:
      signing_protocol: sigv4
      signing_behavior: always
      origin_type: s3

  - logical_name: FrontendDNS
    type: AWS::Route53::RecordSet
    purpose: Custom domain alias to CloudFront (only if domain_name set)
    properties:
      type: A
      alias_target: "{FrontendCDN.DomainName}"

networking:
  vpc: none                   # No VPC needed for static hosting
  subnets: []
  security_groups: []
  load_balancer: none

monitoring:
  dashboards:
    - "{stack.name}-cdn"
  alarms:
    - name: High4xxRate
      metric: 4xxErrorRate (CloudFront)
      threshold: "> 5%"
      action: SNS notification
    - name: High5xxRate
      metric: 5xxErrorRate (CloudFront)
      threshold: "> 1%"
      action: SNS notification
  log_groups:
    - "/aws/cloudfront/{stack.name}"

outputs:
  - name: SiteUrl
    value: "https://{domain_name or FrontendCDN.DomainName}"
    description: Website URL
  - name: CloudFrontDistributionId
    value: "{FrontendCDN.Id}"
    description: CloudFront distribution ID (for cache invalidation during deploys)
  - name: DeployBucketName
    value: "{FrontendBucket.Name}"
    description: S3 bucket name for deploying site files

domain_components: []
