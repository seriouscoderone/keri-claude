# Issuance & Encoding

## Cryptographic Strength

- Subsequent crypto ops MUST preserve minimum strength from initial seed/key (CS-R1)
- Seeds/private keys MUST be generated by CSPRNG
- 128 bits entropy minimum for Perfect Security; non-PS systems MAY need larger keys

## Message Types

| Ilk | Name | Category |
|-----|------|----------|
| *(none)* | ACDC | ACDC Msg -- no `t` field; implied `acm` |
| `acm` | Field Map | ACDC Msg -- "ACdc field Map" |
| `act` | Fixed+Attribute | ACDC Msg -- "ACdc fixed with aTtribute" |
| `acg` | Fixed+Aggregate | ACDC Msg -- "ACdc fixed with aGgregate" |
| `sch` | Schema | Section -- `s` field |
| `att` | Attribute | Section -- `a` field |
| `agg` | Aggregate | Section -- `A` field (selectively disclosable) |
| `edg` | Edge | Section -- `e` field |
| `rul` | Rule | Section -- `r` field |
| `rip` | Registry Inception | TEL -- init blindable state registry |
| `upd` | Update | TEL -- update blindable state registry |

### `t` Field Rules

- MUST in `acm` with CESR serialization (JSON/CBOR/MGPK) (MT-R1)
- MUST in any non-`acm` type regardless of serialization (MT-R2)
- MAY be absent only in non-CESR-native `acm` messages (MT-R3)
- MUST in all native CESR messages (MT-R4)
- Protocol type MUST be `ACDC` (MT-R5)
- Missing `t` implies `acm` (MT-R6)

## Top-Level Field Map

Field order: `[v, t, d, u, i, rd, s, a, A, e, r]` -- MUST appear in this order.

| Field | Type | Req | Constraint |
|-------|------|-----|-----------|
| `v` | str | MUST | Regex: `ACDCMmmGggKKKKSSSS.` |
| `t` | str | see rules | Three-char ilk |
| `d` | str | MUST | Fully qualified SAID |
| `u` | str | MAY | High-entropy pseudo-random string |
| `i` | str | MUST | AID verified via KERI Key State |
| `rd` | str | MAY | Registry Digest SAID |
| `s` | str/map | MUST | Schema SAID or block |
| `a` | str/map | MAY | Attribute SAID or block (exclusive with `A`) |
| `A` | str/list | MAY | Aggregate/selectively disclosable list (exclusive with `a`) |
| `e` | str/map | MAY | Edge SAID or block |
| `r` | str/map | MAY | Rule SAID or block |

When `a` appears, `A` MUST NOT appear; when `A` appears, `a` MUST NOT appear.

## Section Messages

Structure: `[v, t, d, <section-field>]` for every section message.

| Ilk | Section Field |
|-----|--------------|
| `sch` | `s` |
| `att` | `a` |
| `agg` | `A` |
| `edg` | `e` |
| `rul` | `r` |

### Section Message Rules

- MUST have `v`, `t`, `d` fields in that order (SM-R1)
- Embedded section block `d` MUST match the section field value in the ACDC's most compact form (SM-R2)
- Embedded `d` MUST be computed using **most compact SAID** algorithm (SM-R3)
- Top-level section message `d` is NOT computed with most compact SAID algorithm (SM-R4)
- All designated fields are required; no optional fields (SM-R5)
- All field maps MUST include a SAID field (SM-R6)

## CESR Native Formats

### Count Codes

| Format | Count Code | Description |
|--------|-----------|-------------|
| Field map | `-G##` / `--G#####` | Top-level field map messages |
| Fixed field | `-F##` / `--F#####` | Top-level fixed field messages |

### Emptiness Codes

| Value Type | Code | Meaning |
|------------|------|---------|
| CESR primitive | `1AAK` | Null primitive |
| Field map | `-IAA` | Generic map, zero-length |
| List | `-JAA` | Generic list, zero-length |
| String (fixed field) | `4BAA` | Variable-length bytes, zero length |

### Format Variants

**`acm` Field Map** (`-G##`): Required `[v, d, i, s]`; optional `[t, u, rd, a, A, e, r]`. Version omits kind/length (count codes provide).

**`acm` Fixed Field** (`-F##`): ALL fields required; empty values use emptiness codes. `a` and `A` MUST NOT both be non-empty.

**`act` Fixed** (`-F##`): `[v, t, d, u, i, rd, s, a, e, r]` (no `A`). Empty: `4BAA` (string) or `-IAA` (map).

**`acg` Fixed** (`-F##`): `[v, t, d, u, i, rd, s, A, e, r]` (no `a`). Empty: `4BAA` (string), `-JAA` (list), `-IAA` (map).

### Field Label Encoding

| Label | Encoded | Label | Encoded |
|-------|---------|-------|---------|
| `v` | `0J_v` | `rd` | `0Krd` |
| `t` | `0J_t` | `s` | `0J_s` |
| `d` | `0J_d` | `a` | `0J_a` |
| `u` | `0J_u` | `e` | `0J_e` |
| `i` | `0J_i` | `r` | `0J_r` |

Pattern: single-char labels use `0J_` prefix; multi-char labels use `0K` prefix.

CESR native version primitive example (ACDC 2.0, CESR 2.0): `0OACDCCAACAA`

## Selective Disclosure

All implementations MUST support minimal Selective Disclosure mechanisms (SD-R1). Individual ACDCs need not employ them.

### Disclosure Tiers

| Tier | Mechanism | What It Addresses |
|------|-----------|-------------------|
| 1 | ACDC chaining | Decompose bundled credentials into graph of separately disclosable ACDCs |
| 2 | Selectively disclosable attribute ACDCs | Independent disclosure of bundled attributes via aggregate `A` |
| 3 | Bulk-issued ACDCs | Unique SAID per usage context (unbundle revocation registry correlation) |
| 4 | Bulk-issued + unique Issuee AIDs + independent TEL per Issuee | Remove Issuee identity as correlation point |

### Aggregate `A` Computation Methods

1. **Concatenated digest** -- H(concat of ordered attribute block digests)
2. **Merkle tree root** -- more efficient for large attribute sets; interior nodes MUST have second-pre-image attack protection
3. **Cryptographic accumulator** -- over ordered set of digests

### SAID-Preserving Compaction

1. Replace each compactable section (`a`, `e`, `r`) with its `d` SAID
2. Replace nested compactable blocks with their `d` SAID
3. Recalculate version string `v` for new serialized size
4. Top-level `d` SAID MUST remain unchanged
5. Each section SAID MUST equal the `d` from uncompacted section

### Hierarchical UUID Derivation (Selective Disclosure)

Shared secret salt minimizes issuance data transfer. Salt established via **Interactive** (DH, X25519 from Ed25519) or **Non-interactive** (asymmetric encrypt with Issuee X25519 key, Issuer signs; more scalable for multi-sig).

1. Top-level UUID `u`: path `"0"`
2. Attribute UUIDs: paths `"0/0"`, `"0/1"`, `"0/2"`, ...
3. Compute SAID `d` from derived UUIDs
4. Issuer provides signature(s) on compact version + seal references
5. Issuee regenerates everything else at presentation time

## Bulk Issuance

### Proof Requirements

- Issuer MUST anchor issuance proof seal in KEL directly or via TEL (BK-R1)
- Post-rotation forgery requires forking KEL before Rotation (BK-R2, MUST)
- Issuer MAY commit to aggregate `B` (BK-R3)
- Commitment MAY be KEL seal or `td` field in TEL event (BK-R4)
- Bulk-issued TEL SHOULD use blinded state update `bup` (BK-R5)
- Each TEL event MUST be bound with anchoring seal in Issuer's KEL (BK-R6)
- Discloser SHOULD NOT disclose registry SAID before contractual protection (BK-R7)
- `rd` field value MAY be attached to presentation or provided out-of-band (BK-R10)

### Blinded Aggregate `B` Computation

```
For each ACDC k in {0..M-1}:
  1. v_k = derive blinding factor from shared salt, path "k"
     (v_k is NOT the top-level UUID u; separate blinding UUID)
  2. c_k = v_k + d_k        (concatenation, not XOR -- length-independent)
  3. b_k = H(c_k)           (blinded digest)
B = H(C(b_0, b_1, ..., b_{M-1}))   (digest of ordered concatenation)
```

Properties: disclosing b_k does not reveal d_k; full [b_0..b_{M-1}] safely disclosable; commitment to B commits to all d_k.

### Bulk Issuance UUID Derivation

Per member `k`: UUID `u` at path `"k"`, private attribute at `"k/0"`, nested blocks extend hierarchically, selective disclosure element `j` at `"k/j"`. Issuee needs only template + salt + index to regenerate on demand.

### Bulk Issuance Proof Verification

```
verify_bulk_proof(compact_ACDC_k, v_k, [b_0..b_{M-1}], seal_ref):
  1. Compute d_k on disclosed compact ACDC
  2. Compute b_k = H(v_k + d_k)
  3. Confirm b_k in provided list
  4. Compute B = H(C(b_0..b_{M-1}))
  5. Confirm B matches anchored seal:
     - With TEL: seal references registry inception; TEL update has td = B
     - Without TEL: seal directly commits to B
  6. Verify Issuer Key State at time of issuance per KERI
```

Errors: b_k not in list = invalid disclosure; B mismatch = proof fails; Key State fails = unauthorized.

### Merkle Tree Alternative

Aggregate `B` = Merkle tree root of blinded digests b_k. O(log N) verification vs O(N) for concatenated list. Interior branch nodes MUST have second-pre-image attack protection (BK-R14). Proof does not disclose other set members.

### Independent AID Bulk Issuance

1. Issuee creates unique inception events per bulk member (HD key chain: path `k/j` + bulk salt + non-shared salt)
2. Provides unique AIDs to Issuer; Issuer generates ACDCs, registries, seals per AID
3. Each unique-AID copy MUST get its own TEL entry (BK-R12)
4. Each TEL event MUST be bound with anchoring seal in Issuer's KEL (BK-R13)

### SMT Amalgamated Registry (Herd Privacy)

1. Issuer maintains single Sparse Merkle Tree of all event SAIDs across all registries
2. Periodically anchors SMT root in KEL as bulk seal; Observers maintain synced copy
3. Validator queries Observer for inclusion proof without Registrar tracking PoV
4. Optional: random no-op updates strengthen herd privacy

Privacy: SAIDs not guessable; 2nd-party pairs cannot compare proofs; KEL seal not correlatable to any specific registry event.

### Registry SAID Graduated Disclosure

Protect `rd` until contractual protection: (1) empty metadata ACDC, disclose `rd` after terms accepted; (2) `rd` nested in attribute/aggregate section, withhold details; (3) `rd` omitted, communicated out-of-band (no in-ACDC correlation, but no built-in registry discovery).

### Correlation Properties

- Unique SAIDs prevent unpermissioned 3rd-party provable correlation (unless Verifier collusion)
- No crypto mechanism precludes statistical correlation among colluding Verifiers (contextual linkability)
- Without contractually protected disclosure, advanced crypto unlinkability yields diminishing returns

## Registry Inception Event (`rip`)

Fields (all MUST): `v` (version, `ACDC` protocol prefix), `t` (`rip`), `d` (SAID = registry ID), `u` (UUID), `i` (controller AID), `n` (seq number, `"0"` for inception), `dt` (ISO 8601 with microseconds + timezone).

- `d` SAID becomes the `rd` value in ACDCs; `rd` MUST equal associated `rip` SAID
- Version uses `ACDC` prefix (not `KERI`); each AID creates its own registry
- Registry MUST be created before any ACDC referencing it

## Schema Rules

- Schema `$id` MUST match the `s` field value in the ACDC (SCH-R1)
- Every compactable section MUST use `oneOf` with two variants: string (SAID) and object (detail) (SCH-R2)
- `additionalProperties` MUST be `false` on all schema objects (SCH-R3)
- Different structures (e.g., private vs public edges) require different schemas even if they share the same attribute section

## Extensibility

- Extend via chaining: custom ACDCs chain to existing ones via Edge section; pre-issued ACDCs stay valid
- Edges remain verifiable as long as new schema is backward compatible

## Performance

- Signature on SAID = unique commitment; no re-verification after initial check (PS-R4)
- SAID references MAY be verified against data received later (PS-R1); detailed ACDC MAY be cached/on-demand (PS-R2)
- Graph nodes transmitted/verified/cached once per branch, not per leaf (PS-R5)
- Document-based VCs MUST contain whole graph in one document; ACDCs decompose into fragments (PS-R3)
